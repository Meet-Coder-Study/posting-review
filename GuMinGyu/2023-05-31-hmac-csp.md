---
title: hmac, csp
author: mingyu.gu
date: 2023.05.31
---

## CSP

CSP는 Content-Security-Policy 의 약자로 HTTP 보안 정책입니다.

XSS 공격을 완화하는데 도움이 되는 추가 보안 계층으로 HTTP 응답 헤더에 추가하고 user-agent가 해당 페이지에 대해 로드할 수 있는 리소스를 제어합니다.

브라우저는 XSS공격에 매우 취약한데요. 공격할 수 있는 포인트가 너무 많습니다. 예를들어 chrome-extension, npm으로 설치한 script 등 나쁜 개발자가 chrome extension에 외부 스크립트를 주입받도록하는 코드를 삽입하고 해당코드가 실행되어 공격을 하게될 수 있습니다. 또는 개발자들이 개발을 할 때 npm module을 그냥 믿고 사용하게 되는데요. 유명하지 않은 모듈들도 막 가져다 사용하게 됩니다. 이떄 npm module을 무조껀 신뢰하게 됩니다. 하지만 해당 Module에 외부 서버로 데이터를 전송하는 코드가 있다거나 공격 코드가 있을 수 있습니다.

CSP는 이런 공격을 차단합니다. 브라우저에서 실행 가능한 스크립트의 유효한 소스 도메인을 지정하여 XSS가 발생할 수 있는 여지를 줄입니다. 그리고 허용된 도메인에서 받은 소스 파일에서 로드된 스크립트만 실행하고 HTML 속성을 포함한 인라인 스크립트 및 이벤트 처리 등의 다른 모든 스크립트는 무시합니다.

https 통신만 허용하도록도 할 수 있고 이미지 소스는 모든 곳에서 받을 수 있게하되 동영상 파일은 허용한 도메인에서만 받을 수 있게도 할 수 있습니다.

```
Content-Security-Policy: default-src 'self'; img-src *; media-src example.org example.net; script-src userscripts.example.com
```

csp에 report-to 속성에 리포트 받을 url을 넣게 되면 csp를 위반할 때 해당 url에 POST method로 report도 보내줍니다. 

```
{
  "csp-report": {
    "blocked-uri": "http://example.com/css/style.css",
    "disposition": "report",
    "document-uri": "http://example.com/signup.html",
    "effective-directive": "style-src-elem",
    "original-policy": "default-src 'none'; style-src cdn.example.com; report-to /_/csp-reports",
    "referrer": "",
    "status-code": 200,
    "violated-directive": "style-src-elem"
  }
}
```

대부분 sentry를 사용하고 있을테니 report-to도 sentry로 발송하면 되고 sentry report-to uri를 받는 방법은 https://docs.sentry.io/product/security-policy-reporting/ 참고하면 됩니다.

![img](./image/csp-report-uri-sentry.png)

이곳에서 페이지에 security header를 잘 설정하고 있는지 확인도 가능합니다. https://securityheaders.com/

### CSP 셋팅

참고자료 https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/creating-response-headers-policies.html

CloudFront > Policy > response header 부분에 정의하면 됩니다.

![img](./image/csp-cf.png)


## HMAC

hmac은 hashed-message-authentication-code의 약자로

## 참고자료

- https://developer.mozilla.org/ko/docs/Web/HTTP/CSP
- https://web.dev/csp/
- https://web.dev/i18n/ko/strict-csp/
