## 예약 시스템 고민하기

예약 시스템이라는 걸 설계 하기 전, 예약 시스템에 대해 살짝 고민해본다.

`예약 시스템`이란, 시간이라는 자원에 기반한 서비스로 사용자가 특정 시간대에 특정 리소스를 예약하기 때문에, 시간대별 가용성과 리소스의 상태(사용 가능 여부)를 효율적으로 관리하는 것이 핵심이다.

예약의 상태는 일반적으로 예약 대기 , 예약 확정, 취소됨 등의 다양한 상태로 구분된다. 각 상태에 따른 비즈니스 로직을 구현해야 하며, 상태 변경 시 트랜잭션 일관성을 유지하는 것이 중요하다.

자원이 한정된 경우, 예약 대기를 관리할 수 있다. 특정 시간에 자동으로 예약을 확인하거나 만료 처리하는 스케줄링 시스템이 필요 할 수 있다.

## 첫 번째 단계: 문제 이해 및 설계 범위 확정

기능적 요구사항, 비기능적 요구사항을 구체화 하기 위한 질의 및 답변을 진행합니다. 포스팅 편의상 결과 내용만 정리하겠습니다.

### 기능적 요구사항 추출
1. 시스템 규모 - 5000개 호텔 100만 개 객실을 갖춘 호텔 체인을 위한 웹사이트
2. 대금결제 방식 - 예약시 대금지불
3. 예약취소 기능
4. 초과 예약 기능 - 객실 수 + 10% 초과 예약 가능
5. API 명세
  - 호텔 정보 페이지 표시
  - 객실 정보 페이지 표시
  - 객실 예약 지원
  - 호텔이나 객실 정보 추가/삭제/갱신하는 관리자 페이지 지원
  - 초과 예약 지원
6. 객실 가격의 가격변동(Dynamic Pricing)

### 비기능적 요구사항
1. 높은 수준의 동시성 지원
2. 적절한 지연 시간

### 개략적인 규모 추정
- 5000개 호텔, 100만 개의 객실
- 평균 70%가 사용 중, 평균 투숙 기간은 3일
- 일일 예상 예약 건수 100만 * 0.7 / 3 = 233,333 (올림 240,000)
- 초당 예약 건수 = 대략 3TPS
- 모든 페이지의 QPS
  - 호텔/객실 상세 페이지
  - 예약 상세 페이지
  - 객실 예약 페이지
** 대략 10%의 사용자가 다음 단계로 진행 90%의 사용자가 최종 단계에 도달하기 전 서비스 이탈

객실 상세 페이지(QPS=300) -> 예약 상세 페이지(QPS=30) -> 객실 예약 페이지(QPS=3) 
** 최종 예약 TPS는 3, 예약 페이지의 QPS는 30, 객실 정보 확인 페이지의 QPS는 300

## 두 번째 단계: 계략적 설계안 제시 및 동의 구하기

### API 설계하기

예약 시스템 설계에 필요한 API 명세를 정의하였습니다.
호텔 웹사이트를 구현하기 위해 객실 검색하는 등의 직관적인 기능도 필요하다. 하지만 전체적으로는 필요한 기능일 수 있으나 기술적으로 도전적이지 않은 기능은 현재 상황에서 제외 합니다.

#### 호텔 관련 API

| HttpMethod | API Endpoint | 설명 | 권한 |
|--------|--------|--------|--------|
| GET | /v1/hotels/:id | 호텔의 상세 정보 반환 | - |
| POST | /v1/hotels | 신규 호텔 추가 | 호텔 직원만 사용가능 |
| PUT | /v1/hotels/:id | 호텔 정보 갱신 | 호텔 직원만 사용가능 |
| DELETE | /v1/hotels/:id | 호텔 정보 삭제 | 호텔 직원만 사용가능 | 

#### 객실 관련 API

| HttpMethod | API Endpoint | 설명 | 권한 |
|--------|--------|--------|--------|
| GET | /v1/hotels/:hotelId/rooms/:roomId | 객실 상세 정보 반환 | - |
| POST | /v1/hotels/:hotelId/rooms | 신규 객실 추가 | 호텔 직원만 사용가능 |
| PUT | /v1/hotels/:hotelId/rooms/:roomId | 객실 정보 갱신 | 호텔 직원만 사용가능 |
| DELETE | /v1/hotels/: hotelId/rooms/:roomId | 객실 정보 삭제 | 호텔 직원만 사용가능 | 

#### 예약 관련 API

| HttpMethod | API Endpoint | 설명 | 권한 |
|--------|--------|--------|--------|
| GET | /v1/reservations | 로그인 사용자의 예약 이력 반환 | - |
| POST | /v1/reservations/:reservationId | 특정 예약의 상세 정보 반환 | - |
| PUT | /v1/reservations | 신규 예약 | - |
| DELETE | /v1/reservations/:reservationId | 예약 취소 | - | 

##### 멱등(idempotent key) 키에 대한 이야기

[멱등성](https://github.com/SeokRae/202410_blog_13/issues/2#issuecomment-2396662674)이란, 특정 작업을 여러 번 반복 실행해도 결과가 동일하게 유지되는 성질을 의미합니다.
즉, 멱등성을 가진 API나 작업은 동일한 요청이 여러 번 반복되어도 상태나 결과에 변함이 없어야 합니다.

멱등성에서 고려해야 하는 상황으로 몇가지가 있습니다.

1. 상태 변경 여부: 여러 번 요청해도 시스템의 상태가 변하지 않도록 설계.
2. 중복 요청 처리: 고유한 식별자나 idempotency key를 사용해 중복 처리 방지.
3. 결과 일관성: 요청이 여러 번 들어와도 일관된 결과를 반환하도록 보장.
4. 트랜잭션 관리: 동일한 트랜잭션이 중복 처리되지 않도록 관리.
5. [에러 처리](https://github.com/SeokRae/202410_blog_13/issues/2#issuecomment-2395050932): 실패 시에도 일관된 응답을 반환하고 복구 전략을 포함.

### 데이터 모델

예약 시스템의 경우, 프로모션과 같은 이벤트로 인한 트래픽이 급증 할 수도 있기 때문에 이에 대한 대비를 해야 한다.
책에서는 관계형 데이터베이스를 선택한다.

1. 객실을 예약하는 사용자에 비해 호텔 웹 사이트/앱을 방문하는 사용자 수가 압도적으로 많기 때문에 읽기 작업 지원을 잘 제공하는 관계형 데이터베이스를 선택합니다.
2. 이중 청구 문제, 이중 예약 문제등 ACID 속성을 보장하는 관계형 데이터베이스를 선택합니다.
3. 엔티티로 비즈니스 데이터의 구조를 명확하게 표현할 수 있는 관계형 데이터베이스를 선택합니다.

초기 설계 시에 어떤 서비스를 생각하고 모델링 하느냐에 따라 다릅니다. 에어비엔비, 호텔 그외 숙박 시설에 따라 객실 유형이 다를 수 있다는 것을 생각해보아야 합니다.

모델링이 되었다면, 서비스에 대한 구성요소를 고려해볼 수 있습니다.

사용자, 관리자(호텔 직원) CDN, 공개 API 게이트 웨이, 내부 API, 호텔 서비스, 요금 서비스, 예약 서비스, 결제 서비스, 호텔 관리 서비스

## 세 번째 단계: 상세 설계

상세 설계를 진행할 때는 시스템 안정성, 성능, 확장성, 그리고 데이터 일관성을 중점적으로 고려하여 문제를 분석하는 것이 중요합니다. 또한, 장기적인 확장성과 유지보수성을 함께 염두에 두어, 시스템이 성장할 수 있도록 적절한 해결책을 마련하는 것이 필수적입니다.

트러블 슈팅 과정에서는 문제의 빈도와 시스템에 미치는 영향을 기준으로 우선순위를 정해, 발생할 수 있는 문제를 효율적으로 해결해야 합니다. 이를 통해, 설계 단계에서부터 발생 가능한 문제를 미리 대비하고 시스템의 안정성을 높일 수 있습니다.

- 데이터 모델 개선
- 동시성 문제
- 시스템의 규모 확장
- 마이스코서비스 아키텍처에서의 데이터 일관성 문제에 대한 해결 방안

### 모델링 개선

호텔 객실 예약 시 특정 객실이 아닌 특정한 객실 유형을 예약하게 됩니다.
호텔의 모든 객실 유형을 담는 테이블에 대한 포인트 였습니다. 

### 동시성 문제를 해결하는 방법

이중 예약이 발생할 수 있는 사례에 대해 두가지 예를 들어 접근해볼 수 있습니다.

1. 같은 사용자가 예약 버튼을 여러 번 누르는 경우.
2. 여러 사용자가 동시에 같은 객실을 예약하려는 경우.

#### 동시성 문제를 접근하는 세 가지 방법론

1. 비관적 락(Pessimistic Lock)
2. 낙관적 락(Optimistic Lock)
3. 데이터베이스 제약 조건(constraint)

### 시스템 규모 확장

예약 시스템이 단일 서비스가 아닌 플랫폼 형태로 확장을 한다면? 어떤 것들을 고려해야 할까?

객실 타입에 대한 확장성은 고려되어 있다는 것을 보장하고, 성능적인 부분만 고민해 보도록 합니다.

1. 데이터베이스 샤딩
2. 캐시
3. 분산 시스템 아키텍처로 인한 서비스 간 데이터 일관성

## 네 번째 단계: 마무리

호텔 예약 시스템 설계를 진행하며 요구사항을 수집하고, 규모를 추정하여 개략적인 시스템 설계를 완료하였습니다. 이후 API 설계, 데이터 모델링, 시스템 아키텍처 다이어그램을 통해 구체적인 방향을 잡아가던 중, `예약 처리 방식에 대한 관점이 잘못되었음을 확인`하였고, 이를 기반으로 데이터 스키마를 수정하는 과정을 거쳤습니다.

서비스의 특성상 `경쟁 조건(Race Condition)`이 발생할 수 있는 시나리오를 분석하며, 몇 가지 해결책을 제시하였습니다. 특히, `비관적 락(Pessimistic Lock)`과 `낙관적 락(Optimistic Lock)`, 그리고 `데이터베이스 제약 조건` 등을 사용한 `동시성 제어 방안`을 검토하였습니다.

또한, 서비스 확장성을 고려하여 성능 향상을 위한 다양한 전략을 살펴보았습니다. 데이터베이스 샤딩과 레디스 캐시를 도입하여 확장성을 극대화할 수 있는 방안을 논의하였고, 시스템 규모 확장에 대한 준비를 철저히 했습니다.

마지막으로, `마이크로서비스 아키텍처(MSA)`에서 자주 발생할 수 있는 데이터 일관성 문제에 대해 논의하였으며, 이를 해결하기 위한 몇 가지 전략도 검토하였습니다. 이를 해결하기 위해 `2PC(Two-Phase Commit)`와 `사가 패턴(Saga Pattern)`을 검토하였습니다.

결론적으로, 이번 호텔 예약 시스템 설계를 통해 확장성과 성능, 데이터 일관성을 고려한 시스템 설계를 달성했으며, 이러한 과정을 통해 안정적이고 효율적인 예약 시스템을 구현할 수 있음을 확인하였습니다.