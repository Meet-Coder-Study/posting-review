요번에는 엘라스틱 서치의 유사도 스코어 계산법에 대해서 알아보려고 한다.

## 유사도 스코어 계산법

유사도 스코어 ? 질의문과 도큐먼트의 유사도를 표현한 값으로, 스코어가 높을수록 찾고자 하는 도큐먼트에 가깝다는 사실을 의미한다.

엘라스틱 서치는 다양한 스코어 알고리즘을 사용할 수 있는데 기본적으로 BM25 알고리즘을 이용해 유사도 스코어를 계산한다.

BM25 알고리즘 ? 검색, 추천에 많이 사용되는 알고리즘으로 TF(Term Frequency), IDF(Inverse Document Frequency) 개념에 문서 길이를 고려한 알고리즘이다.

> 엘라스틱 서치는 5.x 이전 버전에서는 TF-IDF 알고리즘을 사용했으나, 5.x부터 BM25 알고리즘을 기본적으로 사용한다고 한다.

![](https://blog.kakaocdn.net/dn/M4yhv/btruI7blphC/OxNViqKPcZvMGtEsCwo6Kk/img.png)
BM25 알고리즘 (https://velog.io/@jkl133/BM25)

이제 BM25 알고리즘이 어떻게 검색을 하는지에 대해서 알아보자.

검색 결과에 대한 스코어 계산이 어떻게 되어있는지 알려면 explain 옵션을 추가하여 검색을 하면 된다.

![](https://blog.kakaocdn.net/dn/pNluJ/btruO90MzfN/hXKhJp2ySw8kL8N8jbX5N0/img.png)

explain 속성 넣고 검색을 하면 된다.

검색을 하게 되면 아래의 접은 글을 펼쳤을 때 처럼 하나의 결과에 대해서 스코어 계산이 나온다. 이제부터 해당 결과에 대해서 BM25 알고리즘을 이용하여 어떻게 스코어가 나왔는지 차근차근 알아볼 생각이다.

![](https://blog.kakaocdn.net/dn/bRVVWq/btruIUDNALg/fLmkeSofKWgyqkirdtkWO1/img.png)

일단 총 스코어는 8.268259가 나왔다고 볼 수 있다.

> 스코어는 도큐먼트와 쿼리 간의 연관성 수치로, 값이 클수록 연관성이 높다는 것을 의미한다.

아까전에 BM25 알고리즘은 TF(Term Frequency), IDF(Inverse Document Frequency) 개념에 문서 길이를 고려한 알고리즘이다. 라고 한다. 즉, 8.268259라는 스코어가 IDF와 TF의 값 그리고 최종 스코어 계산식으로 만들어졌다고 알면 된다.

IDF ? 특정 용어가 얼마나 자주 등장했는지를 의미하는 지표이다.

TF ? 특정 용어가 하나의 도큐먼트에 얼마나 많이 등장했는지를 의미하는 지표이다.

IDF는 특정 용어가 얼마나 자주 등장했는지를 의미하는 지표로써 전체 문서에서 자주 발생하는 단어일수록 중요하지 않는 단어로 인식하고 가중치를 낮춘다고 하며, TF는 하나의 도큐먼트에서 특정 용어가 많이 나오면 중요한 용어로 인식하고 가중치를 높인다고 한다.

> 처음 읽으면 확실히 이해가 안되지만, 추가로 설명하자면, IDF는 전체 문서 즉, 전체 Document에서 해당 용어가 자주 나왔는지에 대한 것이고, TF는 하나의 문서, 즉 하나의 Document에서 용어가 자주 나왔는지에 대한 것이다.

![](https://blog.kakaocdn.net/dn/w14F5/btruI7WHJgo/KwuUSipEL6t4f0baRGuYGk/img.png)

IDF에 대한 내용

현재 검색 결과에 대한 IDF는 "Pants"에 대해서 4675(N)개의 전체 문서에서 3(n)개 일치한다고 한다.

> IDF에 대한 계산 식은 log(1+ (N - n + 0.5) / (n + 0.5))

이렇게 IDF는 log(1+ (4675 - 3 + 0.5) / (3 + 0.5))로 계산되어 7.1974354가 나왔다고 보면 된다.

![](https://blog.kakaocdn.net/dn/cexUVU/btruG0Ezoen/1N40sNV4T3oCINygUXDcMK/img.png)

그리고 결과에 대한 TF는 freq, k1, b, dl, avgdl 값을 통하여 구하면 된다고 한다.

> TF 계산식에 대한 계산식 : (freq + k1 * (1 - b + b * dl / avgdl))

freq ? 도큐먼트 내에서 용어가 나온 횟수

k1 / b ? 알고리즘을 정규화하기 위한 가중치로 엘라스틱서치가 디폴트로 취하는 상수.

dl ? 필드 길이, 현재 도큐먼트를 토큰화했을 떄의 토큰 수

avgdl ? 전체 도큐먼트에서 평균 필드 길이다. 모든 도큐먼트를 토큰화했을 때의 도큐먼트 당 갖는 평균 토큰 수

> dl이 작고 avgdl이 클수록 TF 값이 크게 나온다.

![](https://blog.kakaocdn.net/dn/bkRoEb/btruIUxfHfp/BiY8H9ahxv8AndwVxapUjk/img.png)

현재 Pants 검색 중 스코어가 가장 높았던 다큐먼트는 Boots, tan, Casual, Cuffed, Pants로 5개의 토큰으로 이루어져 있어 dl는 5이다.

이렇게 TF는 1 / ( 1+ 1.2 * ( 1 - 0.75 + 0.75 * 5 / 7.3161497)) 로 계산하여 0.52217203이 나온다.

유사 스코어의 마지막 최종 스코어를 알아보자.

![](https://blog.kakaocdn.net/dn/dTEvcl/btruQk815WS/7hdpdAhmw7QkOMPrQNEuNK/img.png)

최종 스코어는 boost이다. boost는 엘라스틱이 지정한 고정값으로 2.2로 정해져있다고 한다.

이렇게 만들어진,

- log(1+ (N - n + 0.5) / (n + 0.5))으로 나온 IDF의 값 7.1974354
- (freq + k1 * (1 - b + b * dl / avgdl)) 으로 나온 TF 값 0.52217203
- 최종 스코어인 2.2 

을 모두 곱하면 최종 유사 스코어 8.269259 가 나온다.

--------------------
### 회고

유사 스코어에 대해서 처음 봤을 때 BM25 알고리즘을 사용하며, 복잡한 식이 인터넷에 떠돌아다녔다. 처음 보자마자 겁을 먹었으나, 진정하고 차근차근 BM25 알고리즘의 요소들이 어떻게 되어있는지 확인하고 분석을 해보니 확실히 간단했으나 나중에 실무에 적용할 때 머리가 아플 것 같은 느낌 아닌 느낌이 들었다. 이러한 상황이 온다면 이제 한 단계 더 업해야되는 상황일 것이라고 생각한다. 즉, 피할 수 없는 상황이니 신나게 계산기 두드리면서 해야되겠다. 어서 이러한 시기가 왔으면 좋겠다. 이러한 시기 하나하나가 나를 더욱 성장시켜줄 것이기 때문이다.
