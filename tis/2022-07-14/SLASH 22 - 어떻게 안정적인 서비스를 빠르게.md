# SLASH 22 - 어떻게 안정적인 서비스를 빠르게, 자주 출시할 것인가?

## 영상

[토스ㅣSLASH 22 - 어떻게 안정적인 서비스를 빠르게, 자주 출시할 것인가?](https://www.youtube.com/watch?v=oakvibIKToc&list=PL1DJtS1Hv1PiGXmgruP1_gM2TSvQiOsFL&index=2)

## 내용

[**어떻게 안정적인 서비스를 빠르게, 자주 출시할 것인가?**](https://www.notion.so/db554fd3ad2b419da527739e4107b7e1)

## 정리

개발자가 작성한 좋은 코드가 제품화되어 가치를 발현할 수 있도록 코드 작성 단계에서부터 서비스 배포 및 운영까지 제품 전달 파이프라인 전체가 잘 구성되는 것이 중요하다.

### 프로젝트 셋업 및 개발

토스페이먼츠는 Boilerplate 프로젝트를 구성해서 운영하고 공통 라이브러리를 제공해 프로젝트 구성을 간소화해 MSA 서비스 추가에 소요되는 시간을 단축하고 있다.

### CI/CD 구성

샘플 YAML 파일을 기반으로 프로젝트명, 도메인, 메모리 할당량 등 최소 수정을 통해 CI/CD 환경의 구성이 가능하도록 해결하고 있다. 

**Github Actions**

Github Actions을 사용하면서 Workflow를 YAML로 정의할 수 있다는 점과 YAML 파일을 Git Repository에 포함만 시켜주는 사용 방법 덕분에 Boilerplate 프로젝트에 포함만 해준다면 큰 노력 없이도 전사시스템을 반영하는 것이 가능하다.

**하드웨어 관리**

개발 환경에 자동 배포되는 환경 구성으로 인해 빌드 작업을 수행할 컴퓨팅 자원이 모자라서 빌드 지연이 발생하는 문제가 있는데, 이 문제를 해결하기 위해 빌드 작업을 수행할 컴퓨팅 자원을 늘릴 수 있는 기능을 제공한다. 또한 모든 빌드 장비가 접근할 수 있는 공유 스토리지를 도입함 빌드가 어느 장비에서 수행되더라도 캐시 히트가 발생하기 때문에 빌드 시간을 줄일 수 있다. 그리고 동적으로 컴퓨팅 자원을 조정하는 것이 가능한데 시간대별로 빌드 서버의 수를 조절해 빌드 요청이 몰리는 시간에도 컴퓨팅 자원이 부족하지 않도록 관리하고 있다.

**애플리케이션 이용**

CI/CD에 소요되는 시간을 최적화하기 위한 노력을 하고 있는데 변경이 잦은 Application Layer와 변경이 자주 발생하지 않는 라이브러리 부분을 구분해서 빌드할 수 있게 해주는 **Spring Boot Layerd Jar**를 사용하고 있다. 그리고 Docker Multi Stage Build를 통해 Dokcer Image 경량화 및 캐시 효과를 높이고 있으며 빌드병렬화 등의 기능을 통해 더 빠른 빌드 속도를 보여주는 **Docker Buildkit**을 사용하고 있다.

### 배포

토스페이먼츠의 거의 모든 프로젝트는 k8s에 배포되고 있으며 lstio에 의해 트레픽이 제어되고 있다. 서비스를 운영하다 보면 개발자가 개발한 서비스 단위 배포가 아닌 k8s, lstio 버전업과 같은 클러스터 레벨의 배포가 필요한 경우가 있다. 이런 작업들을 클러스터 전체에 영향을 줄 수 있는 위험한 작업에 속한다.

**k8s에 배포, lstio를 이용한 트레픽 제어**

lstio를 이용하면 비율단위 트래픽 조절이 가능한데 1% 단위로 신규 버전을 서비스에 적용하는 것이 가능하도록 구성해두어 혹여나 Staging 환경에서 발견하지 못한 문제가 Production 환경에서 발생하더라도 빠른 롤백이 가능해 영향 범위를 최소화하는 것이 가능하다. 

**두 개의 k8s 클러스터를 Active-Active 구조로 운영**

클러스터 레벨의 개선 작업을 부담없이 할 수 있게 해주기 때문에 인프라 레벨의 개선 활동도 빠르고 지속적으로 진행하는데 도움이 된다. 또한 클러스터 레벨의 장애가 발생한 상황에도 트래픽을 조정해 장해를 피하는도록 가능하게 한다.

### 운영

운영에서는 메트릭, 로그, 트레이스, 알림 네 가지로 시스템이 기대한 대로 잘 동작하고 있는지를 파악한다.

**메트릭**

토스페이먼츠는 훌륭한 시각화 기능을 제공함과 동시에 다양한 데이터 스토리지를 지원하는 Grafana를 통해 여러 데이터 소스에 저장된 정보를 조회하고 알림이 생성될 수 있도록 구성하고 있다. 또한 Boilerplate 프로젝트에는 이미 기본적인 모니터링이 가능하도록 구성했다.

**로그**

**로그를 사용하는 이유**

로그는 보관 비용이 많이 발생하는 편이지만 로그는 시스템이 예상치 못한 동작을 했을 때, 문제분석에 매우 중요한 단서가 되고 로그가 있다면 로그가 남아있지 않을 때 대비 원인을 파악하는데 소요되는 시간이 극단적으로 줄어들기 때문에 찾기 쉬운 형태로 오래 보관하는 것이 중요하다.

**로그 관리**

로그는 시간이 갈 수록 양이 방대해지기 때문에 로그가 생성된 시점이 오래될 수록 고사양 장비에 저장된 데이터가 저자양 장비로 이동하도록 구성해 운영함으로써 로그 저장 비용을 줄이고 있다.

**액세스 레벨**

토스페이먼츠는 액세스 레벨의 로그를 식별하기 위해 액세스 로그를 남길 때, 분산 추적에 필요한 식별 정보가 되는 `traceId`와 `spanId`와 어느 API가 요청을 처리했는지 API를 호출한 서비스는 무엇인지 요청을 처리한 k8s 클러스터 및 데이터센터 정보 가맹점 식별 정보 등 특정 요청에 문맥을 이해할 수 있는 다양한 정보를 액세스 로그에 포함시키고 있다.

**트레이스**

토스 페이먼츠는 별개의 로그 뷰어를 만들어 운영하고 있다. 로그는 샘플링하지 않고 100% 다 저장하고 있기 때문에 문제가 생긴 요청이 저장되어 있을까 고민할 필요가 없고 HTTP API 단위의 요청 처리 결과와 함께 개발자가 남겨둔 애플리케이션 로그가 같이 보이도록 구성해서 성능 문제가 아닌 로직 문제인 경우에도 빠르게 확인할 수 있다.

**알림**

알림 종류의 다각화와 개발 및 운영자의 피로가 높아지지 않도록 False Positive, 오탐을 제거하기 위한 노력과 False Negative, 탐지실패를 줄이기 위해 노력하고 있다. 

## 마지막으로

토스 페이먼츠는 안정적인 애플리케이션을 자주 배포하기 위해서 Boilerplate 프로젝트를 구성하고 하드웨어를 관리하고 운영에서 다양한 시각화 프로그램을 사용했다. 이 영상을 보고 정리하면서 토이 프로젝트에서 토스의 프로세스를 얼마나 따라할 수 있을까 고민되는 시간이었다. 특히 Boilerplate 프로젝트를 구성하는건 정말 획기적이었다. MSA를 Boilerplate 프로젝트 기반으로 진행한다면 시간적인 비용에서도 크게 절감이 가능하고 공통 기능을 모아서 처리하게 된다면 유지보수에서도 큰 이점이 생기게 될 것이고 Boilerplate 프로젝트를 적용하기 위해서 모듈화나 라이브러리화는 방법과 관리하는 방법을 알아야 한다는 것을 알게된 시간이었다.