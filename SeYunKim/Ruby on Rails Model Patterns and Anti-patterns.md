<aside>
ğŸ’¡ ì›ë³¸ê¸€ : https://blog.appsignal.com/2020/11/18/rails-model-patterns-and-anti-patterns.html
</aside>

Ruby on Rails íŒ¨í„´ ë° ì•ˆí‹°íŒ¨í„´ ì‹œë¦¬ì¦ˆì˜ . ë‘ë²ˆì§¸ ê²Œì‹œë¬¼ì— ì˜¤ì‹ ê±¸ í™˜ì˜í•©ë‹ˆë‹¤. [ì§€ë‚œ ë¸”ë¡œê·¸ ê²Œì‹œê¸€](https://blog.appsignal.com/2020/08/05/introduction-to-ruby-on-rails-patterns-and-anti-patterns.html)([ë²ˆì—­ë³¸](https://rutgo-letsgo.tistory.com/380))ì—ì„œ ìš°ë¦¬ëŠ” ì¼ë°˜ì ì¸ íŒ¨í„´ê³¼ ì•ˆí‹°íŒ¨í„´ì´ ë¬´ì—‡ì¸ì§€ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ë˜í•œ Rails ì„¸ê³„ì—ì„œ ê°€ì¥ ìœ ëª…í•œ íŒ¨í„´ê³¼ ì•ˆí‹°íŒ¨í„´ì— ëŒ€í•´ì„œë„ ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤. ì´ ê²Œì‹œê¸€ì—ì„œëŠ” ëª‡ ê°€ì§€ Rails ëª¨ë¸ ì•ˆí‹° íŒ¨í„´ê³¼ íŒ¨í„´ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ë§Œì•½ ëª¨ë¸ ë¬¸ì œë¡œ ì–´ë ¤ì›€ì„ ê²ªê³  ìˆë‹¤ë©´ ì´ ê²Œì‹œê¸€ì´ ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤. ëª¨ë¸ì„ ë‹¤ì´ì–´íŠ¸ë¥¼ í•˜ëŠ” ê³¼ì •ì„ ë¹ ë¥´ê²Œ ì§„í–‰í•˜ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ ì‘ì„± ì‹œ í”¼í•´ì•¼ í•  ëª‡ ê°€ì§€ ì‚¬í•­ìœ¼ë¡œ ë§ˆë¬´ë¦¬ í•˜ê² ìŠµë‹ˆë‹¤. ë°”ë¡œ ë„ì–´ë“¤ì–´ ë´…ì‹œë‹¤.

## **~~ì§€ë°©~~ ê³¼ì²´ì¤‘ ëª¨ë¸**

Rails ì›¹ì‚¬ì´íŠ¸ì´ë“  APIì´ë“  Rails ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œí•  ë•Œ ì‚¬ëŒë“¤ì€ ëŒ€ë¶€ë¶„ì˜ ë¡œì§ì„ ëª¨ë¸ì— ì €ì¥í•˜ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. ì§€ë‚œ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì—ì„œ ìš°ë¦¬ëŠ” ë§ì€ ì¼ì„ í•˜ëŠ” `Song` í´ë˜ìŠ¤ë¥¼ ì˜ˆì‹œë¥¼ ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ ëª¨ë¸ê³¼ ê°™ì´ ëª¨ë¸ì— ë§ì€ ì¼ì„ í•˜ë©´ ê·¸ê²ƒì€ [ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)](https://en.wikipedia.org/wiki/Single_responsibility_principle)ì— ìœ„ë°˜í•˜ê²Œ ë©ë‹ˆë‹¤.

í•œë²ˆ ì‚´í´ë´…ì‹œë‹¤.

```ruby
class Song < ApplicationRecord
  belongs_to :album
  belongs_to :artist
  belongs_to :publisher

  has_one :text
  has_many :downloads

  validates :artist_id, presence: true
  validates :publisher_id, presence: true

  after_update :alert_artist_followers
  after_update :alert_publisher

  def alert_artist_followers
    return if unreleased?

    artist.followers.each { |follower| follower.notify(self) }
  end

  def alert_publisher
    PublisherMailer.song_email(publisher, self).deliver_now
  end

  def includes_profanities?
    text.scan_for_profanities.any?
  end

  def user_downloaded?(user)
    user.library.has_song?(self)
  end

  def find_published_from_artist_with_albums
    ...
  end

  def find_published_with_albums
    ...
  end

  def to_wav
    ...
  end

  def to_mp3
    ...
  end

  def to_flac
    ...
  end
end
```

ì´ ëª¨ë¸ì— ë¬¸ì œì ì€ ë…¸ë˜ì™€ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ë¡œì§ì˜ ì“°ë ˆê¸°ì¥ì´ ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë©”ì†Œë“œëŠ” ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ í•˜ë‚˜ì”© ì²œì²œíˆ ì¶”ê°€ë˜ë©´ì„œ ìŒ“ì´ê²Œ ë©ë‹ˆë‹¤.

ë‚˜ëŠ” ëª¨ë¸ ë‚´ë¶€ì˜ ì½”ë“œë¥¼ ë” ì‘ì€ ëª¨ë“ˆë¡œ ë¶„í• í•  ê²ƒì„ ì œì•ˆí–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ê·¸ë ‡ê²Œ í•˜ë©´ ë‹¨ìˆœíˆ ì½”ë“œë¥¼ í•œ ê³³ì—ì„œ ë‹¤ë¥¸ ê³³ìœ¼ë¡œ ì˜®ê¸°ëŠ” . ê²ƒë¿ì…ë‹ˆë‹¤. ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ì½”ë“œë¥¼ ì´ë™í•˜ë©´ ì½”ë“œë¥¼ ë”  ì˜êµ¬ì„±í•˜ê³  ê°€ë…ì„±ì´ ë–¨ì–´ì§€ëŠ” Fat Modalì„ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¼ë¶€ ì‚¬ëŒë“¤ì€ [Railsì˜ concerns](https://blog.appsignal.com/2020/09/16/rails-concers-to-concern-or-not-to-concern.html)ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ ì „ë°˜ì— ê±¸ì³ ë¡œì§ì„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ë°œê²¬í•˜ê¸°ë„ í•©ë‹ˆë‹¤. ì´ì „ì— ì´ ì£¼ì œì— ëŒ€í•´ ê¸€ì„ ì“´ ì ì´ ìˆëŠ”ë°, ì–´ë–¤ ì‚¬ëŒë“¤ì€ ì¢‹ì•„í•˜ê¸°ë„ í•˜ê³ , ì–´ë–¤ ì‚¬ëŒë“¤ì€ ì¢‹ì•„í•˜ì§€ ì•Šê¸°ë„ í–ˆìŠµë‹ˆë‹¤. ì–´ì¨Œë“ , concernsì˜ ê°œë…ì€ ëª¨ë“ˆê³¼ ìœ ì‚¬í•˜ì£ . concernsë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì€ ì½”ë“œë¥¼ ë‹¨ìˆœíˆ ì–´ë””ì—ë‚˜ í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆëŠ” ëª¨ë“ˆë¡œ ì˜®ê¸°ëŠ” ê²ƒë¿ì´ë¼ëŠ” ì ì„ ì¸ì‹í•´ì•¼ í•©ë‹ˆë‹¤.

ë˜ ë‹¤ë¥¸ ëŒ€ì•ˆì€ ì†Œê·œëª¨ í´ë˜ìŠ¤ë¥¼ ë§Œë“  ë‹¤ìŒì— í•„ìš”í•  ë•Œ ë§ˆë‹¤ í˜¸ì¶œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë³€í™˜ ì½”ë“œë¥¼ ë³„ë„ì˜ í´ë˜ìŠ¤ë¡œ ì¶”ì¶œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ruby
class SongConverter
  attr_reader :song

  def initialize(song)
    @song = song
  end

  def to_wav
    ...
  end

  def to_mp3
    ...
  end

  def to_flac
    ...
  end
end

class Song
  ...

  def converter
    SongConverter.new(self)
  end

  ...
end
```

ìš°ë¦¬ëŠ” ì´ì œ ë‹¤ë¥¸ í¬ë§·ì˜ songsë¥¼ ë‹¤ë¥¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ëª©ì ì„ ê°€ì§„ `Songconverter` ê°€ ìˆìŠµë‹ˆë‹¤. ë³€í™˜ì— ëŒ€í•œ ìì²´ í…ŒìŠ¤íŠ¸ì™€ í–¥í›„ì— ë¡œì§ì„ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ë…¸ë˜ë¥¼ MP3ë¡œ ë³€í™˜í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ruby
@song.converter.to_mp3
```

ë‚˜ì•„ê² ì´ê²Œ moduleì´ë‚˜ concernì„ ì‚¬ìš©í•˜ëŠ”ê²ƒë³´ë‹¤ ë” ëª…í™•í•´ ë³´ì…ë‹ˆë‹¤. ì–´ì©Œë©´ ìƒì†ë³´ë‹¤ ì¡°í•©ì„ ë” ì„ í˜¸í•˜ê¸° ë•Œë¬¸ì¼ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì´ ë” ì§ê´€ì ì´ê³  ì½ê¸° ì‰½ë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤. ì–´ëŠ ê¸¸ë¡œ ê°ˆ ê²ƒì¸ì§€ì— ê²°ì •ì„ í•˜ê¸° ì „ì— ë‘ ê°€ì§€ ì‚¬ë¡€ë¥¼ ëª¨ë‘ ê²€í† í•´ë³´ì‹œê¸¸ ë°”ëë‹ˆë‹¤. ë˜í•œ ì›í•˜ë©´ ë‘˜ë‹¤ ì„ íƒí• . ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë¬´ë„ ë‹¹ì‹ ì„ ë§‰ì„ . ìˆœì—†ìŠµë‹ˆë‹¤.

## **SQL Pasta Parmesan**

ì‹¤ìƒí™œì—ì„œ ë§›ì‡ëŠ” íŒŒìŠ¤íƒ€ë¥¼ ì¢‹ì•„í•˜ì§€ ì•ŠëŠ” ì‚¬ëŒì´ ìˆì„ê¹Œìš”? ë°˜ë©´ì— ì½”ë“œ íŒŒìŠ¤íƒ€ì— ê´€í•´í•´ì„œëŠ” ì´ì•¼ê¸°ê°€ ë‹¤ë¦…ë‹ˆë‹¤. ê±°ì˜ ì•„ë¬´ë„ ì¢‹ì•„í•˜ì§€ ì•Šì£ . ê·¸ëŸ´ ë§Œí•œ ì´ìœ ê°€ ìˆìŠµë‹ˆë‹¤. Railsëª¨ë¸ì—ì„œ ActiveRecord ì‚¬ìš©ì´ ìŠ¤íŒŒê²Œí‹°ì²˜ëŸ¼ ì—‰í‚¤ê¸° ì‹œì‘í•˜ë©´ ì½”ë“œë² ì´ìŠ¤ ì „ì²´ë¥¼ ë’¤ë®ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ ì´ ë¬¸ì œë¥¼ í”¼í•  ìˆ˜ ìˆì„ê¹Œìš”?

ê¸´ ì¿¼ë¦¬ê°€ ìŠ¤íŒŒê²Œí‹°ì²˜ëŸ¼ ê¼¬ì´ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ëª‡ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì½”ë“œê°€ ì–´ë–»ê²Œ ì–´ë””ì—ë‚˜ ìˆì„ . ìˆ˜ ìˆëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. Song ëª¨ë¸ë¡œ ëŒì•„ê°€ë´…ì‹œë‹¤. íŠ¹íˆ, ëª¨ë¸ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë ¤ê³  í• ë•Œë¥¼ ìƒê°í•´ë³´ê² ìŠµë‹ˆë‹¤.

```ruby
class SongReportService
  def gather_songs_from_artist(artist_id)
    songs = Song.where(status: :published)
                .where(artist_id: artist_id)
                .order(:title)

    ...
  end
end

class SongController < ApplicationController
  def index
    @songs = Song.where(status: :published)
                 .order(:release_date)

    ...
  end
end

class SongRefreshJob < ApplicationJob
  def perform
    songs = Song.where(status: :published)

    ...
  end
end
```

ìœ„ ì˜ˆì‹œì—ì„œ Song ëª¨ë¸ì´ ì¿¼ë¦¬ë˜ëŠ” ì„¸ ê°€ì§€ ì‚¬ìš© ì‚¬ë¡€ê°€ ìˆìŠµë‹ˆë‹¤.  ë…¸ë˜ì— ëŒ€í•œ ë°ì´í„° ë³´ê³ ì— ì‚¬ìš©ë˜ëŠ” SongReporterServiceì—ì„œëŠ” íŠ¹ì • ì•„í‹°ìŠ¤íŠ¸ì˜ ë…¸ë˜ë¥¼ ê°€ì ¸ì˜¤ë ¤ê³  í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒì— SongControllerì—ì„œ ê²Œì‹œëœ ë…¸ë˜ë¥¼ ê°€ì ¸ì™€ ì¶œì‹œ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ SongRefreshJobì—ì„œëŠ” ê²Œì‹œëœ ë…¸ë˜ë§Œ ê°€ì ¸ì™€ì„œ Jobì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ì´ ì •ë„ë©´ ê´œì°®ì§€ë§Œ, ê°‘ìê¸° ìƒíƒœ ì´ë¦„ì„ releasedë¡œ ë³€ê²½í•˜ê±°ë‚˜ ë…¸ë˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ì„ ë³€ê²½í•˜ê¸°ë¡œ ê²°ì •í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”? ëª¨ë“  ë°œìƒ ë¶€ë¶„ì„ ê°œë³„ì ìœ¼ë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ . ìœ„ì½”ë“œëŠ” DRY ì›ì¹™ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì—ì„œ ì½”ë“œê°€ ë°˜ë³µë˜ê³  ìˆìŠµë‹ˆë‹¤. ì‹¤ë§í•˜ì§€ë§ˆì„¸ìš”. ë‹¤í–‰íˆ ì´ ë¬¸ì œì— ëŒ€í•œ í•´ê²°ì±…ì´ ìˆìŠµë‹ˆë‹¤.

Railsì˜ scopeë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ì½”ë“œë¥¼ DRYí•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. scopeëŠ” ì—°ê´€ ë° ê°ì²´ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¿¼ë¦¬ë¥¼ ì •ì˜í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì½”ë“œê°€ ì½ê¸° ì‰½ê³  ë³€ê²½í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤. í•˜ì§€ë§Œ, ì–´ì©Œë©´ ê°€ì¥ ì¤‘ìš”í•œ ì ì€ scopeë¥¼ ì‚¬ìš©í•˜ë©´ joins, where ë“±ê³¼ ê°™ì€ ë‹¤ë¥¸ activeRecord ë©”ì„œë“œë¥¼ ì—°ê²°í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì…ë‹ˆë‹¤. scopeë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œê°€ ì–´ë–»ê²Œ ë³´ì´ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```ruby
class Song < ApplicationRecord
  ...

  scope :published, ->            { where(published: true) }
  scope :by_artist, ->(artist_id) { where(artist_id: artist_id) }
  scope :sorted_by_title,         { order(:title) }
  scope :sorted_by_release_date,  { order(:release_date) }

  ...
end

class SongReportService
  def gather_songs_from_artist(artist_id)
    songs = Song.published.by_artist(artist_id).sorted_by_title

    ...
  end
end

class SongController < ApplicationController
  def index
    @songs = Song.published.sorted_by_release_date

    ...
  end
end

class SongRefreshJob < ApplicationJob
  def perform
    songs = Song.published

    ...
  end
end
```

ìœ„ì™€ ê°™ì´ í• ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë³µë˜ëŠ” ì½”ë“œë¥¼ ì˜ë¼ë‚´ì„œ ëª¨ë¸ì— ë„£ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ê²ƒì´ í•­ìƒ ìµœì„ ì˜ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. íŠ¹íˆ [God ê°ì²´](https://en.wikipedia.org/wiki/God_object)ë‚˜ Fat Modelì´ë¼ê³  ì§„ë‹¨ë°›ì€ ê²½ìš°ì—ëŠ” ë”ìš± ê·¸ë ‡ìŠµë‹ˆë‹¤. ëª¨ë¸ì— ì ì  ë” ë§ì€ ë©”ì„œë“œì™€ ì±…ì„ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì€ ì¢‹ì€ ìƒê°ì´ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì œ ì¡°ì–¸ì€ ë²”ìœ„ ì‚¬ìš©ì„ ìµœì†Œí•œìœ¼ë¡œ ìœ ì§€í•˜ê³  ê±°ê¸°ì— ì¼ë°˜ì ì¸ ì¿¼ë¦¬ë§Œ ì¶”ì¶œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ìš°ë¦¬ì˜ ê²½, **where(published: true)**ëŠ” ì–´ë””ì—ì„œë‚˜ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì— ì™„ë²½í•œ scopeê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ SQL ê´€ë ¨ ì½”ë“œì˜ ê²½ìš° Repository íŒ¨í„´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ê²Œ ë¬´ì—‡ì¸ì§€ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

## **Repository Pattern**

ì´ë²ˆì— ìš°ë¦¬ê°€ ë³´ì—¬ë“œë¦´ ê²ƒì€ [Domain-Driven Design](https://en.wikipedia.org/wiki/Domain-driven_design) ì±…ì— ì •ì˜ëœ 1:1 Repository íŒ¨í„´ì…ë‹ˆë‹¤. Rails Repository íŒ¨í„´ì˜ ê¸°ë³¸ì ì¸ ì •ì˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë…¼ë¦¬ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë…¼ë¦¬ë¥¼ ë¶„ë¦¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë˜í•œ Active Record ëŒ€ì‹  ì›ì‹œ SQL í˜¸ì¶œì„ ìˆ˜í–‰í•˜ëŠ” ë¦¬í¬ì§€í† ë¦¬ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ë„ ìˆì§€ë§Œ, ì •ë§ í•„ìš”í•˜ì§€ ì•Šì€ í•œ ì´ëŸ¬í•œ ë°©ë²•ì€ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ìš°ë¦¬ê°€ í• ìˆ˜ ìˆëŠ” ì¼ì€ SongRepositoryë¥¼ ë§Œë“¤ê³  ê±°ê¸°ì— ë°ì´í„°ë² ì´ìŠ¤ ë¡œì§ì„ ë„£ëŠ”ê²ƒì…ë‹ˆë‹¤.

```ruby
class SongRepository
  class << self
    def find(id)
      Song.find(id)
    rescue ActiveRecord::RecordNotFound => e
      raise RecordNotFoundError, e
    end

    def destroy(id)
      find(id).destroy
    end

    def recently_published_by_artist(artist_id)
      Song.where(published: true)
          .where(artist_id: artist_id)
          .order(:release_date)
    end
  end
end

class SongReportService
  def gather_songs_from_artist(artist_id)
    songs = SongRepository.recently_published_by_artist(artist_id)

    ...
  end
end

class SongController < ApplicationController
  def destroy
    ...

    SongRepository.destroy(params[:id])

    ...
  end
end
```

ìš°ë¦¬ê°€ ì—¬ê¸°ì„œ í•œ ì¼ì€ ì¿¼ë¦¬ ë¡œì§ì„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•œê²ƒ ì…ë‹ˆë‹¤. ë˜í•œ, ëª¨ë¸ì€ ë” ì´ìƒ scopeì™€ ë¡œì§ê³¼ ê´€ë ¨ì´ ì—†ìŠµë‹ˆë‹¤. ì»¨í‹€ë¡¤ëŸ¬ì™€ ëª¨ë¸ì´ ì–‡ì•„ì„œ ëª¨ë‘ê°€ ë§Œì¡±í•©ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ê²ƒì²˜ëŸ¼ ë³´ì´ë‚˜ìš”?? ê¸€ì„ìš”. ì—¬ì „íˆ ActiveRecordê°€ ëª¨ë“  ë¬´ê±°ìš´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ìš°ë¦¬ì˜ ì‹œë‚˜ë¦¬ì˜¤ëŠ” **find**ë¥¼ ì‚¬ìš©í•´ì„œ ë‹¤ìŒì„ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

```sql
SELECT "songs".* FROM "songs" WHERE "songs"."id" = $1 LIMIT $2  [["id", 1], ["LIMIT", 1]]
```

ìµœì‹ ì˜ ë°©ë²•ì€ ì´ ëª¨ë“  ê²ƒì„ SongRepository ë‚´ë¶€ì— ì •ì˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì•ì„œ ë§í–ˆë“¯ì´ ì €ëŠ” ì´ ë°©ë²•ì„ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. êµ³ì´ í•„ìš”í•˜ì§€ ì•Šê³ , ëª¨ë“  ê¶Œí•œì„ ê°–ê³  ì‹¶ì–´í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ActiveRecord ëŒ€ì‹  raw SQLì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°ëŠ” ActiveRecordì—ì„œ ì‰½ê²Œ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë³µì¡í•œ SQL íŠ¸ë¦­ì´ í•„ìš”í•œ ê²½ìš°ì¼ ë¿ì…ë‹ˆë‹¤.

raw SQLê³¼ ActiveRecordì— ëŒ€í•´ì„œ ì´ì•¼ê¸°ë¥¼ í•˜ë‹¤ ë³´ë‹ˆ í•œ ê°€ì§€ ë” ì–¸ê¸‰í•´ì•¼ í•  ì£¼ì œê°€ ìˆìŠµë‹ˆë‹¤. ë°”ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ê³¼ ê·¸ê²ƒì„ ì˜¬ë°”ë¥´ê²Œ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì´ë‹¤. ì´ì œ ìì„¸íˆ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

## **Migrations â€” ëˆ„ê°€ ì‹ ê²½ì“°ë‚˜ìš”?**

ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‘ì„±í•  ë•Œ ì¢…ì¢… ë“£ëŠ” ë§ì´ â€˜ë§ˆì´ê·¸ë ˆì´ì…˜ ì½”ë“œëŠ” ë‚˜ë¨¸ì§€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë§Œí¼ í›Œë¥­í•  í•„ìš”ê°€ ì—†ë‹¤.â€™ëŠ” ì´ì•¼ê¸° ì…ë‹ˆë‹¤. ì €ëŠ” ì´ ì£¼ì¥ì— ì „í˜€ ê³µê°í•˜ì§€ ëª»í•©ë‹ˆë‹¤. ì‚¬ëŒë“¤ì€ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ â€˜í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ê³  ìŠí˜€ì§€ëŠ” ê²ƒâ€™ì´ë¼ëŠ” ë³€ëª…ìœ¼ë¡œ ëƒ„ìƒˆ ë‚˜ëŠ” ì½”ë“œë¥¼ ì‰½ê²Œ ë„£ì–´ë²„ë¦½ë‹ˆë‹¤.

í˜„ì‹¤ì€ ë‹¤ë¥¸ ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë” ë§ì€ ì‚¬ëŒë“¤ì´ ì‘ì—…í•  ìˆ˜ ìˆìœ¼ë©°, ê·¸ë“¤ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ ë‹¤ë¥¸ ë¶€ë¶„ë“¤ê³¼ì˜ ìƒí˜¸ ì‘ìš©ì— ëŒ€í•´ ì˜ ëª¨ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—‰í„°ë¦¬ ì¼íšŒì„± ì½”ë“œë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜ì— ì‚½ì…í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœê°€ ì†ìƒë˜ê±°ë‚˜ ì´ìƒí•œ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ì¸í•´ ëˆ„êµ°ê°€ì˜ ê°œë°œ í™˜ê²½ì„ ëª‡ ì‹œê°„ ë™ì•ˆ ë§ì¹  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì´ ì•ˆí‹°íŒ¨í„´ì¸ì§€ëŠ” í™•ì‹¤í•˜ì§€ëŠ” ì•Šì§€ë§Œ, ë°˜ë“œì‹œ ìœ ë…í•´ì•¼ í•˜ëŠ” ì‚¬í•­ì…ë‹ˆë‹¤.

ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”? í”„ë¡œì íŠ¸ ì°¸ì—¬ì ëª¨ë‘ì—ê²Œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë” ì‰½ê²Œ ë§Œë“œëŠ” íŒ ëª©ë¡ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### í•­ìƒ Down ë©”ì„œë“œë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

ì–¸ì œ ì–´ë–¤ê²ƒì´ ë¡¤ë°±ë ì§€ ì•Œìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë˜ëŒë¦´ìˆ˜ ì—†ëŠ” ê²½ìš° `ActiveRecord::IrreversibleMigration` ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ì„¸ìš”:

```ruby
def down
  raise ActiveRecord::IrreversibleMigration
end
```

### **ë§ˆì´ê·¸ë ˆì´ì…˜ì—ì„œ ActiveRecordë¥¼ í”¼í•˜ì„¸ìš”.**

ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ì‹œì ì˜ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœë¥¼ ì œì™¸í•œ ì™¸ë¶€ ì¢…ì†ì„±ì„ ìµœì†Œí™” í•´ì•¼ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ActiveRecord validationì´ ì—†ì–´ì„œ ìƒí™©ì„ ë§ì¹ (ë˜ëŠ” ì–´ì©Œë©´ êµ¬í•´ì¤„) ìˆ˜ë„ ì—†ìŠµë‹ˆë‹¤. ìˆœìˆ˜í•œ SQLë§Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ì•„í‹°ìŠ¤íŠ¸ì˜ ëª¨ë“  ë…¸ë˜ë¥¼ ê²Œì‹œí•˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‘ì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```ruby
class UpdateArtistsSongsToPublished < ActiveRecord::Migration[6.0]
  def up
    execute <<-SQL
      UPDATE songs
      SET published = true
      WHERE artist_id = 46
    SQL
  end

  def down
    execute <<-SQL
      UPDATE songs
      SET published = false
      WHERE artist_id = 46
    SQL
  end
end
```

ë§Œì•½ Song ëª¨ë¸ì´ í•„ìš”í•œ ê²½ìš° ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚´ë¶€ì—ì„œ ëª¨ë¸ì„ ì •ì˜í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ `app/models` ì— ìˆëŠ” ì‹¤ì œ ActiveRecord ëª¨ë¸ì´ ë³€ê²½ë˜ì–´ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ê²ƒì´ ì™„ë²½í•œ í•´ê²°ì±…ì´ë¼ê³  í•  ìˆ˜ ìˆì„ê¹Œìš”? ë‹¤ìŒ ì£¼ì œë¡œ ë„˜ì–´ê°‘ì‹œë‹¤.

### **ë°ì´í„°ë§ˆì´ê·¸ë ˆì´ì…˜ê³¼ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë¶„ë¦¬í•´ë¼.**

[ë§ˆì´ê·¸ë ˆì´ì…˜ì— ëŒ€í•œ Rails ê°€ì´ë“œ](https://edgeguides.rubyonrails.org/active_record_migrations.html)ë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ë§ˆì´ê·¸ë ˆì´ì…˜ì€ Active Recordì˜ ê¸°ëŠ¥ìœ¼ë¡œ, ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ë°œì „ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. raw SQLë¡œ ìŠ¤í‚¤ë§ˆ ìˆ˜ì •ì„ ì‘ì„±í•˜ëŠ” ëŒ€ì‹ , ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ Ruby DSLì„ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸” ë³€ê²½ ì‚¬í•­ì„ ê¸°ìˆ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> 

ê°€ì´ë“œì˜ ìš”ì•½ ë‚´ìš©ì— ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì˜ ì‹¤ì œ ë°ì´í„°ë¥¼ í¸ì§‘í•˜ëŠ” ê²ƒì— ëŒ€í•œ ì–¸ê¸‰ì€ ì—†ê³ , ì˜¤ì§ êµ¬ì¡°ì— ëŒ€í•´ì„œë§Œ ì–¸ê¸‰ë§Œ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ë‘ ë²ˆì§¸ í¬ì¸íŠ¸ì—ì„œ songì„ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ ì¼ë°˜ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‚¬ìš©í•œ ê²ƒì€ ì™„ì „íˆ ì˜¬ë°”ë¥¸ ë°©ë²•ì€ ì•„ë‹™ë‹ˆë‹¤. í”„ë¡œì íŠ¸ì—ì„œ ì •ê¸°ì ìœ¼ë¡œ ì´ì™€ ìœ ì‚¬í•œ ì‘ì—…ì„ í•´ì•¼ í•˜ëŠ” ê²½ìš° `[data_migrate gem](https://github.com/ilyakatz/data-migrate)` ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ê³¼ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë¶„ë¦¬í•˜ëŠ” ì¢‹ì€ ë°©ë²•ì…ë‹ˆë‹¤. ì´ gemì„ ì‚¬ìš©í•˜ë©´ ì´ì „ ì˜ˆì œë¥¼ ì‰½ê²Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
bin/rails generate data_migration update_artists_songs_to_published
```

ê·¸ë¦¬ê³  ë‹¤ìŒìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ì„ ì¶”ê°€í•©ë‹ˆë‹¤: 

```ruby
class UpdateArtistsSongsToPublished < ActiveRecord::Migration[7.0]
  def up
    execute <<-SQL
      UPDATE songs
      SET published = true
      WHERE artist_id = 46
    SQL
  end

  def down
    execute <<-SQL
      UPDATE songs
      SET published = false
      WHERE artist_id = 46
    SQL
  end
end
```

ì´ë ‡ê²Œ í•˜ë©´ `db/migrate` ë””ë ‰í„°ë¦¬ ë‚´ë¶€ì˜ ëª¨ë“  ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ê³¼ `db/data` ì—ì„  ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ìœ ì§€ë˜ë‹ˆë‹¤.

## ë§ˆì§€ë§‰ ìƒê°

Railsì—ì„œ ëª¨ë¸ì„ ë‹¤ë£¨ê³  ì½ê¸° ì‰½ê²Œ ìœ ì§€í•˜ëŠ” ê²ƒì€ ëŠì„ì—†ëŠ” ë„ì „ì…ë‹ˆë‹¤. ì´ ë¸”ë¡œê·¸ ê¸€ì—ì„œ í”íˆ ë°œìƒí•˜ëŠ” ë¬¸ì œì— ëŒ€í•œ í•¨ì •ê³¼ í•´ê²°ì±…ì„ ì‚´í´ë³´ì…¨ê¸¸ ë°”ëë‹ˆë‹¤. ì´ ê¸€ì—ì„œ ëª¨ë¸ ë°˜ íŒ¨í„´ê³¼ íŒ¨í„´ ëª©ë¡ì€ ì™„ë²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ë§Œ, ìµœê·¼ì— ë°œê²¬í•œ ê°€ì¥ ì£¼ëª©í•  ë§Œí•œ ê²ƒë“¤ì„ ì†Œê°œí–ˆìŠµë‹ˆë‹¤.

ë” ë§ì€ Rails íŒ¨í„´ê³¼ ë°˜ íŒ¨í„´ì— ê´€ì‹¬ì´ ìˆë‹¤ë©´ ì‹œë¦¬ì¦ˆì˜ ë‹¤ìŒ ì—í”¼ì†Œë“œë¥¼ ê¸°ëŒ€í•´ ì£¼ì„¸ìš”. ë‹¤ê°€ì˜¤ëŠ” ê¸€ì—ì„œëŠ” Rails MVCì˜ ë·° ë° ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ì—ì„œ ë°œìƒí•˜ëŠ” ì¼ë°˜ì ì¸ ë¬¸ì œì™€ í•´ê²°ì±…ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ë‹¤ìŒ ì‹œê°„ê¹Œì§€, ê±´ë°°!

PS. Ruby Magic ê²Œì‹œë¬¼ì´ ë³´ë„ë˜ëŠ” ëŒ€ë¡œ ì½ê³  ì‹¶ìœ¼ì‹œë©´ [Ruby Magic ë‰´ìŠ¤ë ˆí„°ë¥¼ êµ¬ë…í•˜ì‹œê³  ë‹¨ í•˜ë‚˜ì˜ ê²Œì‹œë¬¼ë„ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”!](https://blog.appsignal.com/ruby-magic)
